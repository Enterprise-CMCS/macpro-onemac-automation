name: E2E - OneMAC & SEATool (Self-Hosted with Zscaler)
run-name: "E2E - OneMAC & SEATool Test Suite"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: excel-sync
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  e2e-tests:
    runs-on: [ self-hosted, Windows, X64, e2e ]

    env:
      STATE_USERNAME: ${{ secrets.STATE_USERNAME }}
      STATE_PASSWORD: ${{ secrets.STATE_PASSWORD }}
      CMS_USERNAME: ${{ secrets.CMS_USERNAME }}
      CMS_PASSWORD: ${{ secrets.CMS_PASSWORD }}
      SEA_USERNAME: ${{ secrets.SEA_USERNAME }}
      SEA_PASSWORD: ${{ secrets.SEA_PASSWORD }}

    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      # ----------------------------
      # Set up Java & Maven cache
      # ----------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # ----------------------------
      # Read browser + headless
      # ----------------------------
      - name: Read browser + headless from config.properties
        shell: powershell
        run: |
          $configPath = "src/test/resources/config.properties"
          $browser = (Select-String -Path $configPath -Pattern "browser\s*=").ToString().Split("=")[1].Trim()
          $headless = (Select-String -Path $configPath -Pattern "headless\s*=").ToString().Split("=")[1].Trim()
          Add-Content -Path $env:GITHUB_ENV -Value "BROWSER=$browser"
          Add-Content -Path $env:GITHUB_ENV -Value "HEADLESS=$headless"

      # ----------------------------
      # Run E2E Suite
      # ----------------------------
      - name: Run E2E Suite (OneMAC + SEATool)
        shell: powershell
        continue-on-error: true
        run: |
          mvn clean test `
            "-DsuiteXmlFile=src/test/resources/E2E OneMAC & SEATool.xml" `
            "-Dtestng.parameters.browser=$env:BROWSER" `
            "-Dtestng.parameters.headless=$env:HEADLESS" `
            "-Duser.timezone=America/New_York" `
            "-Drun.id=self-hosted"

      # ----------------------------
      # Prepare Extent Report + Screenshots for upload
      # ----------------------------
      - name: Collect Artifacts
        shell: powershell
        run: |
          $artifactDir = "C:\temp\artifact"
          
          # Remove old folder if exists
          Remove-Item -Recurse -Force $artifactDir -ErrorAction Ignore
          
          # Create artifact folder
          New-Item -ItemType Directory -Path $artifactDir | Out-Null
          
          # Copy extent-report
          if (Test-Path "extent-report") {
              Copy-Item -Path "extent-report\*" -Destination $artifactDir\ -Recurse
              Write-Output "Copied extent-report"
          } else {
              Write-Output "extent-report missing"
          }
          
          # Copy screenshots
          if (Test-Path "screenshots") {
              Copy-Item -Path "screenshots\*" -Destination $artifactDir\ -Recurse
              Write-Output "Copied screenshots"
          } else {
              Write-Output "screenshots missing"
          }
      

      # ----------------------------
      # Upload Artifacts
      # ----------------------------
      - name: Upload Extent Report + Screenshots (Self-Hosted)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: OneMAC-Test-Report-SelfHosted
          path: C:\temp\artifact
          if-no-files-found: warn
