name: E2E - OneMAC & SEATool (Self-Hosted with Zscaler)
run-name: "E2E - OneMAC & SEATool Test Suite"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write   # REQUIRED for pushing Excel updates back to repo

jobs:
  e2e-tests:
    runs-on: [ self-hosted, Windows, X64, e2e ]

    env:
      STATE_USERNAME: ${{ secrets.STATE_USERNAME }}
      STATE_PASSWORD: ${{ secrets.STATE_PASSWORD }}
      CMS_USERNAME: ${{ secrets.CMS_USERNAME }}
      CMS_PASSWORD: ${{ secrets.CMS_PASSWORD }}
      SEA_USERNAME: ${{ secrets.SEA_USERNAME }}
      SEA_PASSWORD: ${{ secrets.SEA_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Required so push works

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Read browser + headless from config.properties
        shell: powershell
        run: |
          $configPath = "src/test/resources/config.properties"
          $browser = (Select-String -Path $configPath -Pattern "browser\s*=").ToString().Split("=")[1].Trim()
          $headless = (Select-String -Path $configPath -Pattern "headless\s*=").ToString().Split("=")[1].Trim()

          Add-Content -Path $env:GITHUB_ENV -Value "BROWSER=$browser"
          Add-Content -Path $env:GITHUB_ENV -Value "HEADLESS=$headless"

      - name: Run E2E Suite (OneMAC + SEATool)
        shell: powershell
        continue-on-error: true
        run: |
          mvn clean test `
            "-DsuiteXmlFile=src/test/resources/E2E OneMAC & SEATool.xml" `
            "-Dtestng.parameters.browser=$env:BROWSER" `
            "-Dtestng.parameters.headless=$env:HEADLESS" `
            "-Duser.timezone=America/New_York"

      - name: Upload Extent Report & Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: E2E-OneMAC-SEATool-Report
          path: |
            extent-report/**
            screenshots/**
          if-no-files-found: warn


      ###############################################################
      #   AUTO COMMIT + PUSH UPDATED EXCEL FILES (WINDOWS SAFE)     #
      ###############################################################

      - name: Configure Git Identity
        if: always()
        shell: powershell
        run: |
          git config user.name "Amjad"
          git config user.email "jad.ammar.co@gmail.com"
          Write-Output "Git identity configured."

      - name: Stage updated Excel files (packages + state counters)
        if: always()
        shell: powershell
        run: |
          $updated = 0
          Write-Output "=== Checking for updated Excel files... ==="

          if (Test-Path "src/test/resources/state_counters.xlsx") {
            git add "src/test/resources/state_counters.xlsx"
            Write-Output "Staged state_counters.xlsx"
            $updated = 1
          } else {
            Write-Output "state_counters.xlsx not found."
          }

          if (Test-Path "src/test/resources/packages.xlsx") {
            git add "src/test/resources/packages.xlsx"
            Write-Output "Staged packages.xlsx"
            $updated = 1
          } else {
            Write-Output "packages.xlsx not found."
          }

          Write-Output "UPDATED=$updated"
          Add-Content -Path $env:GITHUB_ENV -Value "UPDATED=$updated"

          Write-Output "=== Contents of GITHUB_ENV ==="
          Get-Content $env:GITHUB_ENV

      - name: Commit & Push Excel Updates
        if: always()
        shell: powershell
        run: |
          Write-Output "=== Commit Stage Starting ==="
          Write-Output "Value of env:UPDATED is '$($env:UPDATED)'"
          
          if ($env:UPDATED -eq "1") {
            Write-Output "Excel updates detected. Checking staged files..."
          
            if (-not (git diff --cached --quiet)) {
              Write-Output "Changes detected - committing..."
              git commit -m 'CI: Update Excel counters (state_counters + packages)'
          
              Write-Output "Pushing changes..."
              git push origin HEAD:${{ github.ref_name }}
          
              Write-Output "Excel files successfully committed and pushed."
            }
            else {
              Write-Output "No staged changes - skipping commit."
            }
          }
          else {
            Write-Output "No Excel updates detected (UPDATED=$env:UPDATED)."
          }
