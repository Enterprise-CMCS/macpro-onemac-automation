name: OneMAC
run-name: "OneMAC Test Suite"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: excel-sync
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  e2e-tests:
    runs-on: [ self-hosted, Windows, X64, e2e ]

    env:
      STATE_USERNAME: ${{ secrets.STATE_USERNAME }}
      STATE_PASSWORD: ${{ secrets.STATE_PASSWORD }}
      CMS_USERNAME: ${{ secrets.CMS_USERNAME }}
      CMS_PASSWORD: ${{ secrets.CMS_PASSWORD }}
      SEA_USERNAME: ${{ secrets.SEA_USERNAME }}
      SEA_PASSWORD: ${{ secrets.SEA_PASSWORD }}

    steps:
      ###############################################################
      # Checkout
      ###############################################################
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      ###############################################################
      # Read browser/headless
      ###############################################################
      - name: Read browser + headless from config.properties
        shell: powershell
        run: |
          $configPath = "src/test/resources/config.properties"
          
          $browser = (Select-String -Path $configPath -Pattern "browser\s*=").ToString().Split("=")[1].Trim()
          $headless = (Select-String -Path $configPath -Pattern "headless\s*=").ToString().Split("=")[1].Trim()
          
          Add-Content -Path $env:GITHUB_ENV -Value "BROWSER=$browser"
          Add-Content -Path $env:GITHUB_ENV -Value "HEADLESS=$headless"

      ###############################################################
      # Run E2E Suite
      ###############################################################
      - name: Run E2E Suite (OneMAC + SEATool)
        shell: powershell
        continue-on-error: true
        run: |
          mvn clean test `
            "-DsuiteXmlFile=src/test/resources/OneMAC.xml" `
            "-Dtestng.parameters.browser=$env:BROWSER" `
            "-Dtestng.parameters.headless=$env:HEADLESS" `
            "-Duser.timezone=America/New_York"

      ###############################################################
      # Upload artifacts
      ###############################################################
      - name: Upload Extent Report & Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: E2E-OneMAC-SEATool-Report
          path: |
            extent-report/**
            screenshots/**
          if-no-files-found: warn

      ###############################################################
      # Configure Git identity
      ###############################################################
      - name: Configure Git Identity
        if: always()
        shell: powershell
        run: |
          git config user.name "Amjad"
          git config user.email "jad.ammar.co@gmail.com"

      ###############################################################
      # Stage updated Excel files
      ###############################################################
      - name: Stage updated Excel files
        if: always()
        shell: powershell
        run: |
          $updated = 0
          
          if (Test-Path "src/test/resources/state_counters.xlsx") {
            git add "src/test/resources/state_counters.xlsx"
            $updated = 1
          }
          
          if (Test-Path "src/test/resources/packages.xlsx") {
            git add "src/test/resources/packages.xlsx"
            $updated = 1
          }
          
          Add-Content -Path $env:GITHUB_ENV -Value "UPDATED=$updated"

      ###############################################################
      # Commit + Push Excel Updates
      ###############################################################
      - name: Commit & Push Excel Updates
        if: always()
        shell: powershell
        run: |
          if ($env:UPDATED -eq "1") {
          
            if (-not (git diff --cached --quiet)) {
          
              git commit -m "CI: Update Excel counters (state_counters + packages)"
          
              git fetch origin main
              git pull origin main --rebase
              git push origin HEAD:main
            }
          }

      ###############################################################
      # Extract Test Summary
      ###############################################################
      - name: Extract Test Summary
        if: always()
        shell: powershell
        run: |
          $reportFile = "extent-report\OneMAC-TestReport.json"
          
          if (Test-Path $reportFile) {
              $json = Get-Content $reportFile | ConvertFrom-Json
              $PASSED  = ($json | Where-Object { $_.status -eq "PASS" }).Count
              $FAILED  = ($json | Where-Object { $_.status -eq "FAIL" }).Count
              $SKIPPED = ($json | Where-Object { $_.status -eq "SKIP" }).Count
          } else {
              $PASSED  = 0
              $FAILED  = 0
              $SKIPPED = 0
          }
          
          $TOTAL = $PASSED + $FAILED + $SKIPPED
          
          if ($TOTAL -gt 0) {
              $PASS_RATE = [math]::Round(($PASSED / $TOTAL) * 100, 2)
          } else {
              $PASS_RATE = 0
          }
          
          $RUNON_ENV = "$env:RUNNER_NAME"
          
          Add-Content -Path $env:GITHUB_ENV -Value "PASSED=$PASSED"
          Add-Content -Path $env:GITHUB_ENV -Value "FAILED=$FAILED"
          Add-Content -Path $env:GITHUB_ENV -Value "SKIPPED=$SKIPPED"
          Add-Content -Path $env:GITHUB_ENV -Value "TOTAL=$TOTAL"
          Add-Content -Path $env:GITHUB_ENV -Value "PASS_RATE=$PASS_RATE"
          Add-Content -Path $env:GITHUB_ENV -Value "RUNON_ENV=$RUNON_ENV"

      ###############################################################
      # Send Extent Report Email
      ###############################################################
      - name: Send Extent Report Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.APP_PASSWORD }}
          subject: "OneMAC Automation Report"
          to: Amjad.Ammar@icf.com
          from: OneMAC CI
          html_body: |
            <body style="margin:0; padding:0; font-family:Segoe UI, Arial; background:#f5f7fb;">
              <table width="100%" cellpadding="0" cellspacing="0" style="background:#f5f7fb; padding:20px;">
                <tr>
                  <td align="center">
                    <table width="700" cellpadding="0" cellspacing="0" style="background:#ffffff; border-radius:8px;">
            
                      <tr>
                        <td style="background:#1f3a5f; color:white; padding:20px;">
                          <h2 style="margin:0;">OneMAC Automation Report</h2>
                        </td>
                      </tr>
            
                      <tr>
                        <td style="padding:20px;">
                          <h3>Summary</h3>
                          <p><b>Passed:</b> ${{ env.PASSED }}</p>
                          <p><b>Failed:</b> ${{ env.FAILED }}</p>
                          <p><b>Skipped:</b> ${{ env.SKIPPED }}</p>
                          <p><b>Total:</b> ${{ env.TOTAL }}</p>
                          <p><b>Pass Rate:</b> ${{ env.PASS_RATE }}%</p>
                          <p><b>Runner:</b> ${{ env.RUNON_ENV }}</p>
                          <p><b>Repository:</b> ${{ github.repository }}</p>
                        </td>
                      </tr>
            
                      <tr>
                        <td align="center" style="padding:20px;">
                          <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                             style="background:#2E86C1; color:white; padding:12px 25px; text-decoration:none; border-radius:5px;">
                             View Full Report
                          </a>
                        </td>
                      </tr>
            
                      <tr>
                        <td align="center" style="font-size:12px; color:#999; padding:15px;">
                          Generated automatically by GitHub Actions CI.
                        </td>
                      </tr>
            
                    </table>
                  </td>
                </tr>
              </table>
            </body>